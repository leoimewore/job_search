---

- hosts: kubectl_server
  become: yes
  vars_files:
    - vars/aws.yml
  name: Deploy Application on EKS
  tasks:
    - name: Authenticate Docker with AWS ECR
      shell: |
        #aws ecr get-login-password --region {{ AWS_REGION }} | \
        docker login --username AWS --password-stdin {{ AWS_ACCOUNT_ID }}.dkr.ecr.{{ AWS_REGION }}.amazonaws.com 
    - name: Generate Kubernetes Deployment YAML
      template:
        src: deployment.yml.j2
        dest: ./deployment.yml

    - name: Apply Kubernetes Deployment
      command: kubectl apply -f ./deployment.yml
